machine:
  node:
    version: 7.2.0
  environment:
    NODE_CURRENT: 7.2.0
    NODE_012: 0.12.9
general:
  artifacts:
    - "dist"
    - "coverage"
dependencies:
  cache_directories:
    - node_modules
  pre:
    - sudo apt-get update
    - sudo apt-get install libcairo2-dev libjpeg8-dev libpango1.0-dev libgif-dev build-essential g++ libgnome-keyring-dev
  post:
    - ci/getVersion.sh # Determine the version semantic-release will use, so we can include it in the build
test:
  pre:
    - npm run build        # Create Node, web and test builds
  override:
    # `canvas` needs a different install depending on the node version in use.
    - nvm use $NODE_012 && rm -rf node_modules/canvas && npm i && npm run e2e:ivc
    # Clean up and switch back to current node version
    - nvm use $NODE_CURRENT && rm -rf node_modules/canvas && npm i

    - npm run e2e         # Run node end to end tests
    - npm run lint        # Ensure all code adheres to the styleguide
    - npm run docs:check  # Validate documentation using inchjs
    - npm run test:perf   # Run performance tests
    - npm run test:web    # Run web-based tests

    - npm run cover       # Report test coverage locally
    - npm run cover:check # Fail if coverage drops below 100%
    - npm run codeclimate # Run tests and send coverage to code climate
    - cp -R coverage/* $CIRCLE_TEST_REPORTS
deployment:
  publish:
    owner: obartra
    branch: master
    commands:
      - npm run build
      - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
      - npm run semantic-release || exit 0
